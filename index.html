<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pustaka Hadits Indonesia - Referensi Standar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .font-serif { font-family: 'Amiri', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        // Import Icon Lengkap
        import { BookOpen, Search, Heart, Coffee, Wallet, Copy, Share2, X, Bookmark, Loader2, Database, RefreshCw, ArrowDownCircle, Check } from 'lucide-react';

        const SUPABASE_URL = "https://rvadnytkliparikxdjau.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2YWRueXRrbGlwYXJpa3hkamF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTY0MTQsImV4cCI6MjA3OTg3MjQxNH0.tOvhBtbdfj43nv8Ijdfgh2WAGRqsw-Zzr4ckM2imIbU";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DAFTAR KITAB LENGKAP DENGAN ALIAS PENCARIAN
        const BOOK_CATEGORIES = [
          { id: "Shahih Al-Bukhari", queryKey: "Bukhari", aliases: ["bukhari", "bukari"], label: "Bukhari" },
          { id: "Shahih Muslim", queryKey: "Muslim", aliases: ["muslim"], label: "Muslim" },
          { id: "Sunan Abu Dawud", queryKey: "Dawud", aliases: ["dawud", "daud", "abu dawud"], label: "Abu Dawud" },
          { id: "Jami' At-Tirmidzi", queryKey: "Tirmid", aliases: ["tirmidzi", "tirmid", "tirmidhi"], label: "Tirmidzi" },
          { id: "Sunan An-Nasa'i", queryKey: "Nasa", aliases: ["nasai", "nasa", "nasa'i"], label: "An-Nasa'i" },
          { id: "Sunan Ibnu Majah", queryKey: "Majah", aliases: ["majah", "ibnu majah", "ibn majah"], label: "Ibnu Majah" },
          { id: "Muwatta Malik", queryKey: "Malik", aliases: ["malik", "muwatta", "muwatho"], label: "Malik" },
          { id: "Musnad Ahmad", queryKey: "Ahmad", aliases: ["ahmad", "ahmed"], label: "Ahmad" },
          { id: "Sunan Ad-Darimi", queryKey: "Darimi", aliases: ["darimi", "ad-darimi"], label: "Ad-Darimi" },
          { id: "Hadits Qudsi", queryKey: "Qudsi", aliases: ["qudsi", "qudsy"], label: "Qudsi" }
        ];

        // --- PARSER PENCARIAN CERDAS ---
        const parseSmartSearch = (text) => {
            if (!text) return { type: 'empty' };
            const cleanText = text.trim().toLowerCase();

            // 1. Pola "Kitab + Angka" (Contoh: "Bukhari 200")
            for (const book of BOOK_CATEGORIES) {
                for (const alias of book.aliases) {
                    const regex = new RegExp(`(?:hr|hadits)?\\s*${alias}\\s*(?:no|nomor|:|#)?\\s*(\\d+)`, 'i');
                    const match = cleanText.match(regex);
                    if (match) {
                        return { type: 'specific_book_number', bookId: book.id, queryKey: book.queryKey, number: match[1] };
                    }
                }
            }
            // 2. Pola Angka Saja
            if (/^\d+$/.test(cleanText)) return { type: 'number_only', number: cleanText };
            // 3. Teks Biasa
            return { type: 'text', keyword: cleanText };
        };

        // --- KOMPONEN UI ---
        const CopyButton = ({ textToCopy }) => {
          const [copied, setCopied] = useState(false);
          const handleCopy = () => {
            navigator.clipboard.writeText(textToCopy);
            setCopied(true); setTimeout(() => setCopied(false), 2000);
          };
          return <button onClick={handleCopy} className="text-gray-400 hover:text-emerald-600">{copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}</button>;
        };

        const ShareButton = ({ title, text }) => {
          const handleShare = async () => {
            if (navigator.share) try { await navigator.share({ title, text }); } catch {}
            else { navigator.clipboard.writeText(text); alert("Teks disalin."); }
          };
          return <button onClick={handleShare} className="text-gray-400 hover:text-blue-600"><Share2 className="w-4 h-4" /></button>;
        };

        const App = () => {
          const [hadithData, setHadithData] = useState([]);
          const [loading, setLoading] = useState(false);
          const [selectedBook, setSelectedBook] = useState(BOOK_CATEGORIES[0].id);
          const [searchQuery, setSearchQuery] = useState("");
          const [page, setPage] = useState(0);
          const [hasMore, setHasMore] = useState(true);
          const [forcedBookLabel, setForcedBookLabel] = useState(null);
          const [isDonationOpen, setIsDonationOpen] = useState(false);
          const ITEMS_PER_PAGE = 20;

          const fetchHadits = async (isLoadMore = false) => {
            if (!isLoadMore) { 
                setLoading(true); 
                setPage(0); 
                setForcedBookLabel(null);
            }
            
            try {
              const currentPage = isLoadMore ? page + 1 : 0;
              const offset = currentPage * ITEMS_PER_PAGE;
              
              // Parse Search
              const searchIntent = parseSmartSearch(searchQuery);
              let query = supabase.from('hadits_standar').select('*');

              // --- LOGIKA FILTER ---
              if (searchIntent.type === 'specific_book_number') {
                  // Cari Kitab Spesifik + Nomor Urut
                  query = query.ilike('kitab', `%${searchIntent.queryKey}%`)
                               .eq('no_urut_db', searchIntent.number); // Cari berdasarkan urutan rapi
                  
                  if (!isLoadMore) setForcedBookLabel(`Hasil: ${searchIntent.bookId} #${searchIntent.number}`);
              } 
              else if (searchIntent.type === 'number_only') {
                  // Cari Nomor di Kitab Aktif
                  const bookConfig = BOOK_CATEGORIES.find(b => b.id === selectedBook);
                  query = query.eq('kitab', selectedBook)
                               .eq('no_urut_db', searchIntent.number);
              } 
              else {
                  // Cari Teks / Normal
                  const bookConfig = BOOK_CATEGORIES.find(b => b.id === selectedBook);
                  // Default filter kitab aktif jika bukan pencarian spesifik
                  query = query.eq('kitab', selectedBook);
                  
                  if (searchIntent.type === 'text') {
                      const q = searchIntent.keyword;
                      query = query.or(`terjemah.ilike.%${q}%,arab.ilike.%${q}%`);
                  }
              }

              // Sorting & Paging
              query = query.order('no_urut_db', { ascending: true })
                           .range(offset, offset + ITEMS_PER_PAGE - 1);

              const { data, error } = await query;

              if (data) {
                if (isLoadMore) setHadithData(prev => [...prev, ...data]);
                else setHadithData(data);
                
                if (data.length < ITEMS_PER_PAGE) setHasMore(false);
                else setHasMore(true);
                
                if (isLoadMore) setPage(currentPage);
              }
            } catch (err) { console.error(err); } 
            finally { setLoading(false); }
          };

          // Debounce Search
          useEffect(() => {
            const timer = setTimeout(() => fetchHadits(false), 600);
            return () => clearTimeout(timer);
          }, [selectedBook, searchQuery]);

          return (
            <div className="min-h-screen bg-gray-50 font-sans pb-20">
              {/* HEADER & SEARCH */}
              <header className="bg-emerald-800 text-white p-4 sticky top-0 z-50 shadow-md">
                <div className="container mx-auto flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div className="flex items-center gap-2 w-full md:w-auto justify-between">
                        <div className="flex items-center gap-2">
                            <BookOpen className="w-6 h-6" />
                            <div>
                                <h1 className="text-lg font-bold leading-tight">Pustaka Hadits</h1>
                                <p className="text-[10px] text-emerald-200 opacity-80">Referensi Standar Internasional</p>
                            </div>
                        </div>
                        {/* Mobile Donate Button */}
                        <button onClick={() => setIsDonationOpen(true)} className="md:hidden flex items-center gap-1 bg-emerald-700 px-3 py-1 rounded-full text-xs border border-emerald-600">
                            <Heart className="w-3 h-3 fill-current" /> Dukung
                        </button>
                    </div>

                    {/* Search Bar */}
                    <div className="relative w-full md:w-96">
                        <input 
                            type="text" 
                            className="w-full pl-10 pr-4 py-2 rounded-full bg-emerald-900/50 border border-emerald-700 focus:outline-none focus:bg-emerald-900 text-sm placeholder-emerald-300/70"
                            placeholder="Cari... (Contoh: Puasa, atau Bukhari 1)"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                        <Search className="absolute left-3 top-2.5 w-4 h-4 text-emerald-400" />
                    </div>

                    {/* Desktop Donate */}
                    <button onClick={() => setIsDonationOpen(true)} className="hidden md:flex items-center gap-2 bg-emerald-700 hover:bg-emerald-600 px-4 py-2 rounded-full text-sm font-bold transition border border-emerald-600 shadow-sm">
                        <Heart className="w-4 h-4 fill-current" /> Dukung Kami
                    </button>
                </div>
              </header>

              <main className="container mx-auto px-4 py-6">
                {/* Pilihan Kitab (Disembunyikan jika sedang mode search spesifik) */}
                {!forcedBookLabel && (
                    <div className="flex overflow-x-auto gap-2 pb-4 mb-4 hide-scrollbar">
                        {BOOK_CATEGORIES.map(book => (
                            <button key={book.id} onClick={() => { setSelectedBook(book.id); setSearchQuery(""); }}
                                className={`whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition ${selectedBook === book.id ? 'bg-emerald-700 text-white shadow-lg' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`}>
                                {book.label}
                            </button>
                        ))}
                    </div>
                )}

                {/* Header Hasil */}
                <div className="flex items-center gap-2 mb-4 px-1">
                    <div className="h-6 w-1 bg-emerald-500 rounded-full"></div>
                    <h2 className="text-lg font-bold text-gray-800">
                        {forcedBookLabel ? forcedBookLabel : BOOK_CATEGORIES.find(b => b.id === selectedBook)?.label}
                    </h2>
                    {loading && <Loader2 className="w-4 h-4 animate-spin text-emerald-600" />}
                </div>

                {/* Empty State */}
                {!loading && hadithData.length === 0 && (
                    <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed border-gray-200">
                        <Database className="w-12 h-12 mx-auto text-gray-300 mb-3" />
                        <p className="text-gray-400 text-sm">Tidak ada hadits ditemukan.</p>
                        <button onClick={() => { setSearchQuery(""); fetchHadits(false); }} className="mt-4 text-emerald-600 text-sm font-bold hover:underline flex items-center justify-center gap-1">
                            <RefreshCw className="w-3 h-3" /> Reset Pencarian
                        </button>
                    </div>
                )}

                {/* List Hadits */}
                <div className="space-y-4">
                    {hadithData.map((item, idx) => (
                        <div key={idx} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition group">
                            <div className="flex justify-between items-start mb-4 border-b border-dashed border-gray-200 pb-3">
                                <div>
                                    <span className="bg-emerald-100 text-emerald-800 text-xs font-bold px-2 py-1 rounded">
                                        #{item.no_urut_db}
                                    </span>
                                    {/* Menampilkan Nomor Standar Asli (Referensi) */}
                                    <span className="ml-2 text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-200">
                                        Ref: {item.no_standar}
                                    </span>
                                    <div className="mt-1 text-[10px] text-gray-400">
                                        {item.metode_penomoran}
                                    </div>
                                </div>
                                <div className="text-right">
                                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${item.derajat?.toLowerCase() === 'shahih' ? 'bg-emerald-50 text-emerald-600' : 'bg-gray-100 text-gray-500'}`}>
                                        {item.derajat || 'Hadits'}
                                    </span>
                                </div>
                            </div>
                            
                            <p className="font-serif text-right text-2xl leading-loose mb-4 text-gray-800" dir="rtl">
                                {item.arab}
                            </p>
                            <p className="text-sm text-gray-600 leading-relaxed">
                                {item.terjemah}
                            </p>
                            
                            <div className="mt-4 pt-3 border-t border-gray-50 flex justify-between items-center">
                                <div className="text-[10px] text-gray-400 font-medium uppercase tracking-wider">
                                    Perawi: {item.perawi_utama}
                                </div>
                                <div className="flex gap-3">
                                    <CopyButton textToCopy={`${item.arab}\n\n${item.terjemah}\n(${item.kitab} No. ${item.no_urut_db})`} />
                                    <ShareButton title={`Hadits ${item.kitab}`} text={`${item.arab}\n\n${item.terjemah}`} />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
                
                {/* Load More */}
                {hasMore && hadithData.length > 0 && !loading && (
                    <div className="mt-8 text-center">
                        <button onClick={() => fetchHadits(true)} className="bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full text-sm font-medium hover:bg-gray-50 flex items-center gap-2 mx-auto shadow-sm">
                            <ArrowDownCircle className="w-4 h-4" /> Muat Lebih Banyak
                        </button>
                    </div>
                )}
              </main>

              {/* MODAL DONASI */}
              {isDonationOpen && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-sm animate-fade-in">
                  <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden relative">
                    <button onClick={() => setIsDonationOpen(false)} className="absolute top-4 right-4 p-1 rounded-full hover:bg-slate-100"><X className="w-5 h-5 text-slate-400" /></button>
                    <div className="bg-emerald-50 p-8 text-center border-b border-emerald-100">
                      <Coffee className="w-10 h-10 text-emerald-600 mx-auto mb-3" />
                      <h3 className="text-xl font-bold text-emerald-800">Dukung Pustaka Hadits</h3>
                      <p className="text-emerald-700/80 text-sm mt-2">Bantu operasional server dakwah digital ini.</p>
                    </div>
                    <div className="p-6 space-y-4">
                      <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex items-center gap-4">
                        <div className="p-3 bg-white rounded-lg shadow-sm"><Wallet className="w-6 h-6 text-blue-600" /></div>
                        <div>
                          <p className="text-xs text-slate-400 font-bold uppercase">BCA (Bank Central Asia)</p>
                          <div className="flex items-center gap-2">
                            <p className="text-lg font-mono font-bold text-slate-800">095-475-8989</p>
                            <CopyButton textToCopy="0954758989" />
                          </div>
                          <p className="text-xs text-slate-500">a.n. Almi Yudianto</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>